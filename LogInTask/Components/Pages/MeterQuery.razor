@page "/query"
@using LogInTask.Models
@using LogInTask.Services
@using LogInTask.Components.Layout
@using FluentValidation
@using Microsoft.JSInterop
@layout MainLayout
@inject IElectricMeterService ElectricMeterService
@inject IValidator<MeterQueryRequest> Validator
@inject IJSRuntime JS

<div class="page-content">
    <div class="text-center mb-4">
        <h2 class="fw-bold">Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2>
        <p class="text-muted">Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-lg border-0">
                <div class="card-body p-4">
                    <EditForm Model="@Request" OnValidSubmit="@OnSubmit">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯</label>
                            <input class="form-control form-control-lg text-end"
                                   value="@Request.MeterNo"
                                   @oninput="OnMeterInput"
                                   maxlength="13"
                                   placeholder="Ø£Ø¯Ø®Ù„ 11 Ø£Ùˆ 13 Ø±Ù‚Ù…Ù‹Ø§" />
                            @if (!string.IsNullOrEmpty(MeterNoError))
                            {
                                <div class="text-danger small mt-1">@MeterNoError</div>
                            }
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Ø§Ù„Ù…Ø¨Ù„Øº (Ø´ÙŠÙ‚Ù„)</label>
                            <input class="form-control form-control-lg text-end"
                                   type="number"
                                   step="20"
                                   min="20"
                                   max="500"
                                   @bind="Request.Amount"
                                   placeholder="20 - 500" />
                            @if (!string.IsNullOrEmpty(AmountError))
                            {
                                <div class="text-danger small mt-1">@AmountError</div>
                            }
                        </div>

                        @if (!string.IsNullOrEmpty(FormError))
                        {
                            <div class="alert alert-danger">@FormError</div>
                        }

                        <button class="btn btn-primary btn-lg w-100"
                                type="button"
                                @onclick="OnSubmitClicked"
                                disabled="@IsLoading">
                            @if (IsLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</span>
                            }
                            else
                            {
                                <span>ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¢Ù†</span>
                            }
                        </button>
                    </EditForm>
                </div>
            </div>

            @* Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… *@
            @if (LastQueryResults != null)
            {
                <div class="card shadow-lg border-0 mt-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…</h5>
                    </div>
                    <div class="card-body">
                        @if (!LastQueryResults.Success)
                        {
                            <div class="alert alert-warning">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¯Ø§Ø¯.</div>
                        }
                        else
                        {
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <th style="width: 40%">Ø§Ù„Ø§Ø³Ù…</th>
                                        <td>@LastQueryResults.CustomerName</td>
                                    </tr>
                                    <tr>
                                        <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯</th>
                                        <td>@LastQueryResults.MeterNumber</td>
                                    </tr>
                                    <tr>
                                        <th>Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                                        <td>@LastQueryResults.AccountNumber</td>
                                    </tr>
                                    <tr>
                                        <th>Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</th>
                                        <td>@LastQueryResults.AccountUsed</td>
                                    </tr>
                                    <tr>
                                        <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø´Ø­Ù†</th>
                                        <td class="fw-bold text-success">@LastQueryResults.RechargeAmount Ø´ÙŠÙ‚Ù„</td>
                                    </tr>
                                    <tr>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <td>@LastQueryResults.Timestamp.ToLocalTime()</td>
                                    </tr>
                                </tbody>
                            </table>

                            <div class="d-grid gap-2 mt-3">
                                <button class="btn btn-success btn-lg" @onclick="OnProcessPaymentClicked" disabled="@PaymentLoading">
                                    @if (PaymentLoading)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</span>
                                    }
                                    else
                                    {
                                        <span>ğŸ’³ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯ÙØ¹</span>
                                    }
                                </button>
                                <button class="btn btn-secondary" @onclick="ResetForm">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                            </div>
                        }
                    </div>
                </div>
            }

            @* Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¯ÙØ¹ *@
            @if (LastPaymentResult != null && LastPaymentResult.Success)
            {
                <div class="card shadow-lg border-0 mt-4" style="border-left: 5px solid #10b981 !important;">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">âœ… ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-bordered">
                            <tbody>
                                <tr>
                                    <th style="width: 40%">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯</th>
                                    <td>@LastPaymentResult.MeterNumber</td>
                                </tr>
                                <tr>
                                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                                    <td>@LastPaymentResult.CustomerName</td>
                                </tr>
                                <tr>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                    <td class="fw-bold text-success">@LastPaymentResult.AmountPaid Ø´ÙŠÙ‚Ù„</td>
                                </tr>
                                <tr>
                                    <th>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©</th>
                                    <td>@LastPaymentResult.UnitsAdded ÙƒÙŠÙ„ÙˆÙˆØ§Øª</td>
                                </tr>
                                <tr class="table-warning">
                                    <th>Ø±Ù…Ø² Ø§Ù„Ø´Ø­Ù†</th>
                                    <td class="fw-bold">@LastPaymentResult.Token</td>
                                </tr>
                                <tr>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                                    <td>@LastPaymentResult.ReferenceNumber</td>
                                </tr>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <td>@LastPaymentResult.Timestamp.ToLocalTime()</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="d-grid">
                            <button class="btn btn-outline-secondary" @onclick="ClosePaymentResult">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private MeterQueryRequest Request { get; set; } = new();
    private MeterQueryResponse? LastQueryResults;
    private PaymentResponse? LastPaymentResult;
    private string? FormError;
    private string? MeterNoError;
    private string? AmountError;
    private bool IsLoading;
    private bool PaymentLoading;

    private async Task OnSubmitClicked() => await OnSubmit();

    private async Task OnSubmit()
    {
        LastPaymentResult = null;
        ClearErrors();
        var validation = await Validator.ValidateAsync(Request);
        if (!validation.IsValid)
        {
            foreach (var e in validation.Errors)
            {
                if (e.PropertyName == nameof(Request.MeterNo))
                    MeterNoError = e.ErrorMessage;
                else if (e.PropertyName == nameof(Request.Amount))
                    AmountError = e.ErrorMessage;
                else
                    FormError = "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØµØ­ÙŠØ­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.";
            }
            return;
        }

        IsLoading = true;
        StateHasChanged();

        try
        {
            LastQueryResults = await ElectricMeterService.QueryMeterAsync(Request);
            if (LastQueryResults?.Success != true)
                FormError = "ØªØ¹Ø°Ø± Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…. ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯.";
        }
        catch
        {
            FormError = "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ù„Ù„ ØªÙ‚Ù†ÙŠ. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task OnProcessPaymentClicked()
    {
        if (LastQueryResults == null)
            return;

        bool confirm = await JS.InvokeAsync<bool>("confirm", $"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¯ÙØ¹ {Request.Amount} Ø´ÙŠÙ‚Ù„ Ù„Ø¹Ø¯Ø§Ø¯ Ø±Ù‚Ù… {Request.MeterNo}ØŸ");
        if (!confirm)
            return;

        PaymentLoading = true;
        StateHasChanged();

        try
        {
            LastPaymentResult = await ElectricMeterService.ProcessPaymentAsync(Request);
            if (LastPaymentResult?.Success == true)
                await ResetFormAfterPayment();
            else
                FormError = "Ù„Ù… ØªÙƒØªÙ…Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.";
        }
        catch
        {
            FormError = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙŠ ÙˆÙ‚Øª Ù„Ø§Ø­Ù‚.";
        }
        finally
        {
            PaymentLoading = false;
        }
    }

    private void ClearErrors()
    {
        FormError = MeterNoError = AmountError = null;
    }

    private async Task ResetFormAfterPayment()
    {
        var paymentResult = LastPaymentResult;
        Request = new();
        LastQueryResults = null;
        LastPaymentResult = paymentResult;
        await InvokeAsync(StateHasChanged);
    }

    private void ResetForm()
    {
        Request = new();
        LastQueryResults = null;
        LastPaymentResult = null;
        ClearErrors();
    }

    private void OnMeterInput(ChangeEventArgs e)
    {
        var raw = e.Value?.ToString() ?? string.Empty;
        var digits = new string(raw.Where(char.IsDigit).ToArray());
        if (digits.Length > 13)
            digits = digits.Substring(0, 13);
        Request.MeterNo = digits;
    }

    private void ClosePaymentResult()
    {
        LastPaymentResult = null;
        StateHasChanged();
    }
}
